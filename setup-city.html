<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>

	<link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.css">

	<style>
		.search {
			position: relative;
		}

		input.search__input {
			width: 100%;
			display: block;
			box-sizing: border-box; 
			padding: 1em;
			position: relative;
			margin-bottom: 0;
		}

		.search__results {
			display: block;
			list-style: none;
			box-shadow: 0 0 4px 0 rgba(0,0,0,0.25);
			position: absolute;
			width: 100%;
			background-color: #FFF;
			margin: 0;
			min-height: 50px;
		}

		.search__results li:nth-child(even) {
			background-color: #EFEFEF;
		}

		.search__select {
			display: block;
			padding: 0.25em 0.5em;
		}

		.search__select:hover {
			background-color: #EFEFEF;
		}

		/*.search__*/
	</style>
</head>
<body>
	<div class="container-fluid">
		<div class="search">
			<h1 class="search__title">Find a City</h1>

			<input class="search__input" type="search" />

			<ul class="search__results list-unstyled">
			</ul>

			<!-- <table class="table table-striped search__results">
				<tr class="search__result row-fluid">
					<td class="span8">
						<a href="#" class="search__select">Dubai Marina, UAE - 42<sup>&deg;</sup></a>
					</td>
				</tr>
				<tr class="search__result row-fluid">
					<td class="span8">
						Dubai Marina, UAE
					</td>
				</tr>
			</table> -->
		</div>

		<div class="selection">
		</div>
		
		<form id="pair-form">
			<input type="hidden" name="location-id" value="" />
			<button type="submit" class="btn btn-default">Pair with This Location</button>
		</form>
	</div>

	<script src="https://code.jquery.com/jquery-3.2.1.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>

	<script>

	var search = {
		tpl: $('<li><a href="#" data-location-id="" class="search__select"></a></li>'),
		$container: $('.search'),
		$input: $('.search__input'),
		$resultsContainer: $('.search__results'),
		results: {},
		_searchDebounce: null,
		onSearch: function (q) {
			clearTimeout(search._searchDebounce);

			search.results = {};
			search.renderHTML('search');
			search.renderHTML('show');

			search._searchDebounce = setTimeout(function () {
				$.get('http://localhost:8888/api/locations', {
					query: search.$input.val()
				}, function (res) {
					res.locations.forEach(function (location) {
						search.results[location.id] = location;
					});
					search.renderHTML('search');
				})
			}, 500)
		},
		onSelect: function (locationId) {
			selection.setSelection(search.results[locationId]);

			search.$input.val(search.results[locationId].name);
			search.$resultsContainer.hide();
		},
		renderHTML: function (action) {
			switch (action) {
				case 'search':
					search.$resultsContainer.empty();

					for (var prop in search.results) {
						var $res = search.tpl.clone();

						$('a', $res)
							.data('location-id', search.results[prop].id)
							.text(search.results[prop].name);

						search.$resultsContainer.append($res);
					}
					break;
				case 'hide':
					search.$resultsContainer.hide();
					break;
				case 'show':
					search.$resultsContainer.show();
					break;
				default:
					break;
			} 
		},
		initialize: function () {
			search.$resultsContainer.on('click', '.search__select', function (evt) {
				evt.stopPropagation();
				evt.preventDefault();

				search.onSelect($(evt.target).data('locationId'));
			});

			search.$input.on('keyup', function () {
				search.onSearch(search.$input.val());
			});

			search.renderHTML('hide');
		}
	};

	var selection = {
		$form: $("#pair-form"),
		$container: $('.selection'),
		$tpl: $('<div><h2></h2> <ul></ul></div>'),
		value: {},
		setSelection: function (data) {
			selection.value = data;

			$.get('http://localhost:8888/api/' + [data.latitude, data.longitude].join(',') + '/weather').then(function (response) {
				selection.value.sunrise = moment(response.sunrise).format('h:mm:ss a');
				selection.value.sunset = moment(response.sunset).format('h:mm:ss a');

				selection.value.forecast = response.hours;

				selection.renderHTML();
			});
		},
		onSubmit: function () {
			selection.$form.on("submit", function (evt) {
				evt.preventDefault();
				evt.stopPropagation();

				window.alert('submit!');

/*
></div>
<input type="hidden" name="temp-time-from" id="time-range-from">
<input type="hidden" name="temp-time-to" id="time-range-to">
</div>

<div class="col-3">
<label>Set to</label>
<select name="temp">
<option value="18">18&deg;</option>
<option value="19">19&deg;</option>
<option value="20">20&deg;</option>
<option value="21">21&deg;</option>
<option value="22">22&deg;</option>
<option value="23">23&deg;</option>	
 */
				// $.post('http://localhost:8888/api/configureBulk', {
				// 	forecast: selection.value.forecast
				// }).then(function () {
				// 	window.location.href = "http://localhost:8888/"
				// });
			});
		},
		renderHTML: function () {
			selection.$container.empty();

			var $sel = selection.$tpl.clone();
			var $title = $('h2', $sel);
			var $ul = $('ul', $sel);

			selection.value.forecast.forEach(function (hour, i) {
				if (i > 12) {
					return;
				}

				var $li = $('<li />');
				$li.text(moment(hour.time).format('h:mm:ss a') + ' - ' + hour.temp + 'ยบ');
				$ul.append($li);
			});

			$title.text(selection.value.name);

			selection.$container.append($sel);
		},
		initialize: function () {
			selection.$container.empty();

			selection.$form.on("submit", function (evt) {
				evt.preventDefault();
				evt.stopPropagation();

/*
></div>
<input type="hidden" name="temp-time-from" id="time-range-from">
<input type="hidden" name="temp-time-to" id="time-range-to">
</div>

<div class="col-3">
<label>Set to</label>
<select name="temp">
<option value="18">18&deg;</option>
<option value="19">19&deg;</option>
<option value="20">20&deg;</option>
<option value="21">21&deg;</option>
<option value="22">22&deg;</option>
<option value="23">23&deg;</option>	
 */

				$.post('http://localhost:8888/api/configureBulk', {
					forecast: selection.value.forecast
				}).then(function () {
					window.location.href = "http://localhost:8888/"
				});
			});
		}
	};

	search.initialize();
	selection.initialize();

	</script>
</body>
</html>